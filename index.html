<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Generator</title>
    <style>
        body {
            background-color: rgb(248 250 252);
            padding: 1.5rem;
            font-family: 'Arial', sans-serif;
            color: rgb(30 41 59);
            line-height: 1.5;
            margin: 0;
        }

        .container {
            max-width: 64rem;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 300;
            color: rgb(30 41 59);
            text-align: left;
            margin-bottom: 2rem;
        }

        h1 span {
            font-size: 0.875rem;
            color: rgb(148 163 184);
            margin-left: 0.5rem;
        }

        .control-panel {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid rgb(226 232 240);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgb(51 65 85);
            margin-bottom: 0.75rem;
        }

        .time-signature-group {
            display: flex;
            gap: 0.75rem;
        }

        .time-signature-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid rgb(226 232 240);
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-signature-btn:hover {
            border-color: rgb(148 163 184);
        }

        .time-signature-btn.active {
            border: 2px solid rgb(59 130 246);
            background-color: rgb(239 246 255);
            color: rgb(29 78 216);
        }

        .number-input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .number-btn {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgb(226 232 240);
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            color: rgb(51 65 85);
        }

        .number-btn:hover {
            border-color: rgb(148 163 184);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }

        input[type="number"] {
            width: 5rem;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid rgb(226 232 240);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .checkbox-label input[type="checkbox"] {
            /* Hide the actual checkbox */
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid rgb(226 232 240);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            /* Add these properties to make the entire label act as a button */
            user-select: none;
            -webkit-user-select: none;
        }

        .checkbox-label:hover {
            background-color: rgb(248 250 252);
        }

        .checkbox-label.checked {
            border-color: rgb(59 130 246);
            background-color: rgb(239 246 255);
        }

        .note-icon {
            font-size: 1.25rem;
        }

        .toggle-group {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgb(226 232 240);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgb(226 232 240);
            transition: .4s;
            border-radius: 1rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.125rem;
            bottom: 0.125rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: rgb(59 130 246);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
        }

        .generate-btn {
            margin-top: 1.5rem;
            background-color: rgb(59 130 246);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .generate-btn:hover {
            background-color: rgb(37 99 235);
        }

        #osmd-container {
            background-color: white;
            border: 1px solid rgb(226 232 240);
            border-radius: 0.75rem;
            height: 24rem;
            width: 100%;
            overflow: auto;
        }


        /* CSS rules */
        @media screen and (max-width: 640px) {
            .controls-grid {
                grid-template-columns: 1fr;  /* Change to single column */
                gap: 1rem;  /* Slightly reduce gap for mobile */
            }

            .control-panel {
                padding: 1rem;  /* Slightly reduce padding for mobile */
            }

            /* Make time signature buttons stack if too narrow */
            @media screen and (max-width: 350px) {
                .time-signature-group {
                    flex-direction: column;
                    gap: 0.5rem;
                }
            }

            /* Ensure checkbox grid stays 2 columns until very narrow screens */
            @media screen and (max-width: 300px) {
                .checkbox-grid {
                    grid-template-columns: 1fr;
                }
            }
        }

    </style>
    <script src="opensheetmusicdisplay.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ProRhythm <span>v1.1</span></h1>
        
        <div class="control-panel">
            <div class="controls-grid">
                <!-- Left Column -->
                <div>
                    <div class="form-group">
                        <label class="input-label">Time Signature</label>
                        <div class="time-signature-group">
                            <button class="time-signature-btn active" data-value="4/4">4/4</button>
                            <button class="time-signature-btn" data-value="3/4">3/4</button>
                            <button class="time-signature-btn" data-value="6/8">6/8</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="input-label">Number of Bars</label>
                        <div class="number-input-group">
                            <button class="number-btn" onclick="decrementBars()">−</button>
                            <input type="number" id="numberOfBars" min="1" max="16" value="4">
                            <button class="number-btn" onclick="incrementBars()">+</button>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <label class="input-label">Include Note Types</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label checked">
                            <input type="checkbox" id="includeEighth" checked>
                            <span class="note-icon">♪</span>
                            <span>Eighth Notes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="includeSixteenth">
                            <span class="note-icon">♬</span>
                            <span>Sixteenth Notes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="includeTriplet">
                            <span class="note-icon">♪♪♪</span>
                            <span>Triplets</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="includeSyncopation">
                            <span class="note-icon">♪♩♪</span>
                            <span>Syncopation</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="toggle-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="showStave" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="input-label" style="display: inline-block; margin-left: 0.75rem;">Show Staff Lines</span>
            </div>

            <button id="generateRhythms" class="generate-btn">
                Generate Rhythm
            </button>
        </div>

        <div id="osmd-container"></div>
    </div>

    <script>
        
        // Add this for the new number input controls
        function incrementBars() {
            const input = document.getElementById('numberOfBars');
            input.value = Math.min(16, parseInt(input.value) + 1);
        }

        function decrementBars() {
            const input = document.getElementById('numberOfBars');
            input.value = Math.max(1, parseInt(input.value) - 1);
        }

        // Add checkbox styling
        document.querySelectorAll('.checkbox-label input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                this.closest('.checkbox-label').classList.toggle('checked', this.checked);
            });
        });

        // Add time signature button styling
        document.querySelectorAll('.time-signature-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-signature-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function enforceMinValue(input) {
            if (input.value < 1) {
                input.value = 1;
            }
        }

        const NoteType = {
            QUARTER: 'quarter',
            EIGHTH: 'eighth',
            SIXTEENTH: 'sixteenth',
            DOTTED_QUARTER: 'dottedQuarter',
            TRIPLET_EIGHTH: 'tripletEighth',
            QUARTER_REST: 'quarterRest',
            EIGHTH_REST: 'eighthRest',
            SIXTEENTH_REST: 'sixteenthRest',
            HALF_REST: 'halfRest',
            WHOLE_REST: 'wholeRest',
            DOTTED_QUARTER_REST: 'dottedQuarterRest',
            TRIPLET_EIGHTH_REST: 'tripletEighthRest'
        };

        const NoteGroup = {
            SINGLE: 'single',
            BEAM: 'beam',
            TRIPLET: 'triplet'
        };

        class TimeSignature {
            constructor(beats, beatType) {
                this.beats = beats;
                this.beatType = beatType;
                this.predefinedMeasures = this.generatePredefinedMeasures();
            }

            generatePredefinedMeasures() {
                switch(`${this.beats}/${this.beatType}`) {
                    case '4/4':
                        return [
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER},{type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}],
                                types: []
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: []
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.HALF_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: []
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}],
                                types: ['eighth']
                            },
                            // {
                            //     rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.SINGLE, note: NoteType.SIXTEENTH_REST}, {type: NoteGroup.SINGLE, note: NoteType.SIXTEENTH}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                            //     types: ['sixteenth']
                            // },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.TRIPLET, notes: [NoteType.TRIPLET_EIGHTH, NoteType.TRIPLET_EIGHTH, NoteType.TRIPLET_EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}],
                                types: ['triplet', 'eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.DOTTED_QUARTER, NoteType.EIGHTH]},{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},{type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['eighth','syncopated']
                            },
                            //{
                            //     rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.QUARTER, NoteType.EIGHTH]},{type: NoteGroup.SINGLE, note: NoteType.QUARTER},{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}],
                            //     types: ['eighth','syncopated']
                            // },
                            {rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type:NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['eighth','sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth', 'sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth', 'sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth', 'sixteenth']
                            }
                        ];
                    case '3/4':
                        return [
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: []
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.HALF_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: []
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.EIGHTH}, {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['eighth', 'syncopated']
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]}],
                                types: ['eighth', 'syncopated']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.EIGHTH}],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['eighth', 'sixteenth']
                            },
                            {
                                rhythm: [{type: NoteGroup.TRIPLET, notes: [NoteType.TRIPLET_EIGHTH, NoteType.TRIPLET_EIGHTH, NoteType.TRIPLET_EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}],
                                types: ['triplet', 'eighth']
                            },
                            {rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type:NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER}],
                                types: ['sixteenth', 'eighth']
                            },
                            {rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.DOTTED_QUARTER, NoteType.EIGHTH]},{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}],
                                types: ['eighth','syncopated']
                            },
                            {
                            rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.QUARTER, NoteType.EIGHTH]},{type: NoteGroup.SINGLE, note: NoteType.QUARTER},{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]}],
                            types: ['eighth','syncopated']
                            },
                            {
                            rhythm: [
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                            ],
                            types: ['sixteenth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                            ],
                            types: ['sixteenth', 'eighth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                            ],
                            types: ['sixteenth', 'eighth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                            ],
                            types: ['sixteenth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}
                            ],
                            types: ['sixteenth', 'eighth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                            ],
                            types: ['sixteenth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                            ],
                            types: ['eighth', 'sixteenth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                            ],
                            types: ['eighth', 'sixteenth']
                        },
                        {
                            rhythm: [
                                {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]},
                                {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                            ],
                            types: ['eighth', 'sixteenth']
                        }
                        ];
                    case '6/8':
                        return [
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}, {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER_REST}],
                                types: []
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]}
                                ],
                                types: ['eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH}
                                ],
                                types: ['eighth','syncopated']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['eighth','syncopated']
                            },
                            {
                                rhythm: [{type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.EIGHTH}, {type: NoteGroup.BEAM, notes: [NoteType.QUARTER, NoteType.EIGHTH]}],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.QUARTER, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.QUARTER_REST}, {type: NoteGroup.SINGLE, note: NoteType.EIGHTH}],
                                types: ['eighth']
                            },
                            {
                                rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH]}, {type: NoteGroup.SINGLE, note: NoteType.EIGHTH_REST}, {type: NoteGroup.BEAM, notes: [NoteType.EIGHTH, NoteType.EIGHTH, NoteType.EIGHTH]}],
                                types: ['eighth']
                            },
                            // {
                            //     rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.SINGLE, note: NoteType.SIXTEENTH_REST}, {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.BEAM, notes: [NoteType.QUARTER, NoteType.EIGHTH]}],
                            //     types: ['sixteenth', 'eighth']
                            // },
                            // {
                            //     rhythm: [{type: NoteGroup.BEAM, notes: [NoteType.QUARTER, NoteType.EIGHTH]}, {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}, {type: NoteGroup.SINGLE, note: NoteType.SIXTEENTH_REST}, {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH]}],
                            //     types: ['eighth', 'sixteenth']
                            // },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.DOTTED_QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                                ],
                                types: ['sixteenth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]},
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                                ],
                                types: ['sixteenth', 'eighth']
                            },
                            {
                                rhythm: [
                                    {type: NoteGroup.SINGLE, note: NoteType.QUARTER},
                                    {type: NoteGroup.SINGLE, note: NoteType.EIGHTH},
                                    {type: NoteGroup.BEAM, notes: [NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH, NoteType.SIXTEENTH]}
                                ],
                                types: ['sixteenth', 'eighth']
                            }
                        ];
                    default:
                        return [{
                            rhythm: [{type: NoteGroup.SINGLE, note: NoteType.WHOLE_REST}],
                            types: []
                        }];
                }
            }
        }

        class RhythmGenerator {
            constructor() {
                this.osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmd-container", {
                    drawTitle: false,
                    drawPartNames: false,
                    drawMeasureNumbers: false,
                    drawTimeSignatures: true,
                    drawingParameters: "compact"
                });

                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('generateRhythms').addEventListener('click', () => this.generateRhythms());
                document.getElementById('showStave').addEventListener('change', (e) => this.updateStaveVisibility(e.target.checked));
                document.getElementById('numberOfBars').addEventListener('change', (e) => enforceMinValue(e.target));
            }

            generateRhythms() {
                const timeSignature = document.querySelector('.time-signature-btn.active').getAttribute('data-value');                const numberOfBars = parseInt(document.getElementById('numberOfBars').value);
                const includeEighth = document.getElementById('includeEighth').checked;
                const includeSixteenth = document.getElementById('includeSixteenth').checked;
                const includeTriplet = document.getElementById('includeTriplet').checked;
                const includeSyncopation = document.getElementById('includeSyncopation').checked;
                const showStave = document.getElementById('showStave').checked;

                const [beats, beatType] = timeSignature.split('/').map(Number);
                const ts = new TimeSignature(beats, beatType);

                const measures = this.generateMeasuresWithRhythmTypes(ts, numberOfBars, includeEighth, includeSixteenth, includeTriplet, includeSyncopation);
                const musicXML = this.createMusicXML(measures, ts);
                this.loadMusicXML(musicXML, showStave);
            }

            generateMeasuresWithRhythmTypes(timeSignature, numberOfBars, includeEighth, includeSixteenth, includeTriplet, includeSyncopation) {
                const measures = [];
                let availableMeasures = timeSignature.predefinedMeasures.filter(measure => {
                    if (!includeEighth && measure.types.includes('eighth')) return false;
                    if (!includeSixteenth && measure.types.includes('sixteenth')) return false;
                    if (!includeTriplet && measure.types.includes('triplet')) return false;
                    if (!includeSyncopation && measure.types.includes('syncopated')) return false;
                    return true;
                });

                if (availableMeasures.length === 0) {
                    console.error('No measures available with the selected rhythm types');
                    return measures;
                }

                // Create a copy of availableMeasures to reset when all measures have been used
                const allAvailableMeasures = [...availableMeasures];

                for (let i = 0; i < numberOfBars; i++) {
                    if (availableMeasures.length === 0) {
                        // If all measures have been used, reset the available measures
                        availableMeasures = [...allAvailableMeasures];
                    }

                    const randomIndex = Math.floor(Math.random() * availableMeasures.length);
                    measures.push(availableMeasures[randomIndex].rhythm);
                    
                    // Remove the selected measure from the available measures
                    availableMeasures.splice(randomIndex, 1);
                }

                return measures;
            }

            createMusicXML(measures, timeSignature) {
                let xml = `
                    <?xml version="1.0" encoding="UTF-8"?>
                    <!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
                    <score-partwise version="3.1">
                    <part-list>
                        <score-part id="P1">
                        <part-name>Music</part-name>
                        </score-part>
                    </part-list>
                    <part id="P1">
                `;

                measures.forEach((measure, index) => {
                    xml += `<measure number="${index + 1}">`;
                    if (index === 0) {
                        xml += `
                            <attributes>
                            <divisions>4</divisions>
                            <time>
                                <beats>${timeSignature.beats}</beats>
                                <beat-type>${timeSignature.beatType}</beat-type>
                            </time>
                            <clef>
                                <sign>G</sign>
                                <line>2</line>
                            </clef>
                            </attributes>
                        `;
                    }

                    measure.forEach(group => {
                        switch (group.type) {
                            case NoteGroup.SINGLE:
                                xml += this.createNoteXML(group.note);
                                break;
                            case NoteGroup.BEAM:
                                group.notes.forEach((note, i) => {
                                    xml += this.createNoteXML(note, i === 0 ? 'begin' : i === group.notes.length - 1 ? 'end' : 'continue');
                                });
                                break;
                            case NoteGroup.TRIPLET:
                                group.notes.forEach((note, i) => {
                                    xml += this.createNoteXML(note, i === 0 ? 'begin' : i === group.notes.length - 1 ? 'end' : 'continue', true);
                                });
                                break;
                        }
                    });

                    xml += '</measure>';
                });

                xml += '</part></score-partwise>';
                return xml;
            }

            createNoteXML(note, beam = null, inTriplet = false) {
                let duration, type, dotTag = '', timeModificationTag = '', restTag = '';
                
                switch (note) {
                case NoteType.QUARTER:
                case NoteType.QUARTER_REST:
                    duration = 4;
                    type = 'quarter';
                    break;
                case NoteType.EIGHTH:
                case NoteType.EIGHTH_REST:
                    duration = 2;
                    type = 'eighth';
                    break;
                case NoteType.SIXTEENTH:
                case NoteType.SIXTEENTH_REST:
                    duration = 1;
                    type = '16th';
                    break;
                case NoteType.DOTTED_QUARTER:
                case NoteType.DOTTED_QUARTER_REST:
                    duration = 6;
                    type = 'quarter';
                    dotTag = '<dot/>';
                    break;
                case NoteType.TRIPLET_EIGHTH:
                case NoteType.TRIPLET_EIGHTH_REST:
                    duration = 2;
                    type = 'eighth';
                    timeModificationTag = `
                    <time-modification>
                    <actual-notes>3</actual-notes>
                    <normal-notes>2</normal-notes>
                    </time-modification>
                    `;
                    break;
                case NoteType.HALF_REST:
                    duration = 8;
                    type = 'half';
                    break;
                case NoteType.WHOLE_REST:
                    duration = 16;
                    type = 'whole';
                    break;
                }
                
                if (note.includes('Rest')) {
                    restTag = '<rest/>';
                }
                
                let xml = `
                    <note>
                        ${restTag}
                        <duration>${duration}</duration>
                        <type>${type}</type>
                        ${dotTag}
                        ${timeModificationTag}
                `;

                if (beam && !note.includes('Rest')) {
                    xml += `<beam number="1">${beam}</beam>`;
                }
                if (!note.includes('Rest')) {
                                    xml += `
                                        <pitch>
                                        <step>G</step>
                                        <octave>4</octave>
                                        </pitch>
                                        `;
                                    }

                                    if (inTriplet) {
                                        xml += `
                                            <notations>
                                                <tuplet type="${beam === 'begin' ? 'start' : beam === 'end' ? 'stop' : ''}" number="1" bracket="yes"/>
                                            </notations>
                                        `;
                                    }

                                    xml += '</note>';
                                    return xml;
                                }

                                loadMusicXML(xmlString, showStave) {
                                    this.osmd.load(xmlString).then(() => {
                                        this.osmd.render();
                                        setTimeout(() => this.updateStaveVisibility(showStave), 0);
                                    });
                                }

                                updateStaveVisibility(showStave) {
                                    const svg = document.querySelector("#osmd-container svg");
                                    if (!svg) return;

                                    const staveLines = svg.querySelectorAll("path[stroke-width='0.5']");
                                    const barLines = svg.querySelectorAll("path[stroke-width='1']");
                                    const clefs = svg.querySelectorAll("g[class^='vf-clef']");

                                    [staveLines, barLines, clefs].forEach(elements => {
                                        elements.forEach(el => el.style.display = showStave ? '' : 'none');
                                    });

                                    const noteGroups = svg.querySelectorAll("g[class^='vf-stavenote']");
                                    const otherElements = svg.querySelectorAll("g[class^='vf-time'], g[class^='vf-keysig']");

                                    [noteGroups, otherElements].forEach(elements => {
                                        elements.forEach(el => {
                                            const currentTransform = el.getAttribute('transform');
                                            if (currentTransform) {
                                                const match = currentTransform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                                                if (match) {
                                                    const x = parseFloat(match[1]);
                                                    const y = parseFloat(match[2]);
                                                    el.setAttribute('transform', `translate(${x}, ${showStave ? y : y - 40})`);
                                                }
                                            }
                                        });
                                    });
                                }
                            }

                            // Initialize the app
                            document.addEventListener('DOMContentLoaded', () => {
                                new RhythmGenerator();
                            });
                        </script>
                    </body>
                    </html>
