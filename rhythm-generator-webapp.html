<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .control-panel {
            margin-bottom: 20px;
        }
        #osmd-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
        }
        #error-message {
            color: red;
            font-weight: bold;
        }
    </style>
    <script src="opensheetmusicdisplay.min.js"></script>
</head>
<body>
    <div class="control-panel">
        <label for="timeSignature">Time Signature:</label>
        <select id="timeSignature">
            <option value="4/4">4/4</option>
            <option value="3/4">3/4</option>
            <option value="6/8">6/8</option>
        </select>

        <label for="numberOfBars">Number of Bars:</label>
        <input type="number" id="numberOfBars" min="1" max="16" value="4">

        <label for="showStave">
            <input type="checkbox" id="showStave" checked>
            Show Stave
        </label>

        <button id="generateRhythms">Generate Rhythms</button>
    </div>

    <div id="error-message"></div>
    <div id="osmd-container"></div>

    <script>
        // TimeSignature class
        class TimeSignature {
            constructor(beats, beatType) {
                this.beats = beats;
                this.beatType = beatType;
                this.predefinedMeasures = this.generatePredefinedMeasures();
            }

            generatePredefinedMeasures() {
                return [
                    [['quarter', 'rest'], ['quarter'], ['quarter'], ['quarter']],
                    [['quarter'], ['quarter', 'rest'], ['quarter'], ['quarter']],
                    [['half', 'rest'], ['quarter'], ['quarter']],
                    [['whole', 'rest']]
                ];
            }
        }

        // NoteType enum (simplified)
        const NoteType = {
            QUARTER: 'quarter',
            EIGHTH: 'eighth',
            SIXTEENTH: 'sixteenth',
            QUARTER_REST: 'quarter_rest',
            EIGHTH_REST: 'eighth_rest',
            SIXTEENTH_REST: 'sixteenth_rest',
            HALF_REST: 'half_rest',
            WHOLE_REST: 'whole_rest'
        };

        // Main app logic
        class RhythmGenerator {
            constructor() {
                this.osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmd-container", {
                    drawTitle: false,
                    drawPartNames: false,
                    drawMeasureNumbers: false,
                    drawTimeSignatures: true,
                    drawingParameters: "compact"
                });

                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('generateRhythms').addEventListener('click', () => this.generateRhythms());
                document.getElementById('showStave').addEventListener('change', (e) => this.updateStaveVisibility(e.target.checked));
            }

            generateRhythms() {
                const timeSignature = document.getElementById('timeSignature').value;
                const numberOfBars = parseInt(document.getElementById('numberOfBars').value);
                const showStave = document.getElementById('showStave').checked;

                const [beats, beatType] = timeSignature.split('/').map(Number);
                const ts = new TimeSignature(beats, beatType);

                const measures = Array(numberOfBars).fill().map(() => 
                    ts.predefinedMeasures[Math.floor(Math.random() * ts.predefinedMeasures.length)]
                );

                const musicXML = this.createMusicXML(measures, ts);
                this.loadMusicXML(musicXML, showStave);
            }

            createMusicXML(measures, timeSignature) {
                let xml = `
                    <?xml version="1.0" encoding="UTF-8"?>
                    <!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
                    <score-partwise version="3.1">
                    <part-list>
                        <score-part id="P1">
                        <part-name>Music</part-name>
                        </score-part>
                    </part-list>
                    <part id="P1">
                `;

                measures.forEach((measure, index) => {
                    xml += `<measure number="${index + 1}">`;
                    if (index === 0) {
                        xml += `
                            <attributes>
                            <divisions>4</divisions>
                            <time>
                                <beats>${timeSignature.beats}</beats>
                                <beat-type>${timeSignature.beatType}</beat-type>
                            </time>
                            <clef>
                                <sign>G</sign>
                                <line>2</line>
                            </clef>
                            </attributes>
                        `;
                    }

                    measure.forEach(note => {
                        xml += this.createNoteXML(note);
                    });

                    xml += '</measure>';
                });

                xml += '</part></score-partwise>';
                return xml;
            }

            createNoteXML(note) {
                const [type, rest] = note;
                const duration = type === 'quarter' ? 4 : (type === 'half' ? 8 : 16);
                const xmlType = type === 'half' ? 'half' : (type === 'whole' ? 'whole' : 'quarter');
                
                return `
                    <note>
                    ${rest ? '<rest/>' : ''}
                    <duration>${duration}</duration>
                    <type>${xmlType}</type>
                    ${!rest ? '<pitch><step>C</step><octave>4</octave></pitch>' : ''}
                    </note>
                `;
            }

            loadMusicXML(xmlString, showStave) {
                this.osmd.load(xmlString).then(() => {
                    this.osmd.render();
                    setTimeout(() => this.updateStaveVisibility(showStave), 0);
                });
            }

            updateStaveVisibility(showStave) {
                const svg = document.querySelector("#osmd-container svg");
                if (!svg) return;

                const staveLines = svg.querySelectorAll("path[stroke-width='0.5']");
                const barLines = svg.querySelectorAll("path[stroke-width='1']");
                const clefs = svg.querySelectorAll("g[class^='vf-clef']");

                [staveLines, barLines, clefs].forEach(elements => {
                    elements.forEach(el => el.style.display = showStave ? '' : 'none');
                });

                const noteGroups = svg.querySelectorAll("g[class^='vf-stavenote']");
                const otherElements = svg.querySelectorAll("g[class^='vf-time'], g[class^='vf-keysig']");

                [noteGroups, otherElements].forEach(elements => {
                    elements.forEach(el => {
                        const currentTransform = el.getAttribute('transform');
                        if (currentTransform) {
                            const match = currentTransform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                            if (match) {
                                const x = parseFloat(match[1]);
                                const y = parseFloat(match[2]);
                                el.setAttribute('transform', `translate(${x}, ${showStave ? y : y - 40})`);
                            }
                        }
                    });
                });
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new RhythmGenerator();
        });
    </script>
</body>
</html>
